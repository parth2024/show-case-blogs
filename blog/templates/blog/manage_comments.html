{% extends "blog/base.html" %}
{% load static %}

{% block title %}Manage Comments{% endblock %}

{% block content %}
<div class="h-full flex" x-data="{ sidebarOpen: true, isMobile: window.innerWidth < 1024 }" 
     @resize.window="isMobile = window.innerWidth < 1024">
    
    <!-- Sidebar -->
    {% include "blog/_sidebar.html" %}

    <!-- Main Content -->
    <div class="flex-1 flex flex-col lg:ml-64">
        <!-- Header -->
        <header class="bg-white border-b border-gray-200 sticky top-0 z-30">
            <div class="px-6 py-4">
                <div class="flex items-center justify-between">
                    <div class="flex items-center space-x-4">
                        <button @click="sidebarOpen = !sidebarOpen" class="btn-ghost p-2 lg:hidden">
                            <i class="fas fa-bars text-lg"></i>
                        </button>
                        <div>
                            <h1 class="text-2xl font-heading font-bold text-gray-900">Comment Management</h1>
                            <p class="text-sm text-gray-600">Moderate and manage user comments</p>
                        </div>
                    </div>
                    <a href="{% url 'blog:admin_dashboard' %}" class="btn btn-secondary hidden sm:flex">
                        <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"/>
                        </svg>
                        Back to Dashboard
                    </a>
                </div>
            </div>
        </header>
        
        <main class="flex-1 overflow-y-auto bg-gray-50 p-8">
            <!-- Statistics -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                <div class="card p-6">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm font-medium text-gray-600 mb-1">Total Comments</p>
                            <p class="text-3xl font-heading font-bold text-gray-900">{{ stats.total_comments }}</p>
                        </div>
                        <div class="w-12 h-12 bg-blue-100 rounded-lg flex items-center justify-center">
                            <i class="fas fa-comments text-blue-600 text-xl"></i>
                        </div>
                    </div>
                </div>
                
                <div class="card p-6">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm font-medium text-gray-600 mb-1">Pending Approval</p>
                            <p class="text-3xl font-heading font-bold text-orange-600">{{ stats.pending_comments }}</p>
                        </div>
                        <div class="w-12 h-12 bg-orange-100 rounded-lg flex items-center justify-center">
                            <i class="fas fa-clock text-orange-600 text-xl"></i>
                        </div>
                    </div>
                </div>
                
                <div class="card p-6">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm font-medium text-gray-600 mb-1">Approved</p>
                            <p class="text-3xl font-heading font-bold text-green-600">{{ stats.approved_comments }}</p>
                        </div>
                        <div class="w-12 h-12 bg-green-100 rounded-lg flex items-center justify-center">
                            <i class="fas fa-check-circle text-green-600 text-xl"></i>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Filters and Search -->
            <div class="card p-6 mb-8">
                <form method="get" class="flex flex-col lg:flex-row gap-4">
                    <!-- Status Filter -->
                    <div class="flex-1">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Filter by Status</label>
                        <div class="flex gap-2">
                            <a href="?status=all{% if search_query %}&search={{ search_query }}{% endif %}" 
                               class="btn {% if status_filter == 'all' %}btn-primary{% else %}btn-outline{% endif %}">
                                All
                            </a>
                            <a href="?status=pending{% if search_query %}&search={{ search_query }}{% endif %}" 
                               class="btn {% if status_filter == 'pending' %}btn-primary{% else %}btn-outline{% endif %}">
                                Pending
                                {% if stats.pending_comments > 0 %}
                                <span class="ml-2 badge badge-warning">{{ stats.pending_comments }}</span>
                                {% endif %}
                            </a>
                            <a href="?status=approved{% if search_query %}&search={{ search_query }}{% endif %}" 
                               class="btn {% if status_filter == 'approved' %}btn-primary{% else %}btn-outline{% endif %}">
                                Approved
                            </a>
                        </div>
                    </div>

                    <!-- Search -->
                    <div class="flex-1">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Search Comments</label>
                        <div class="relative">
                            <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                <i class="fas fa-search text-gray-400"></i>
                            </div>
                            <input 
                                type="text" 
                                name="search" 
                                value="{{ search_query }}"
                                placeholder="Search by name, email, content, or article..."
                                class="input pl-10"
                            >
                            <input type="hidden" name="status" value="{{ status_filter }}">
                        </div>
                    </div>

                    <div class="flex items-end">
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-search mr-2"></i>
                            Search
                        </button>
                    </div>
                </form>

                {% if search_query %}
                <div class="mt-4 flex items-center justify-between">
                    <p class="text-sm text-gray-600">
                        Showing results for: <strong class="text-gray-900">"{{ search_query }}"</strong>
                    </p>
                    <a href="?status={{ status_filter }}" class="text-sm link">
                        Clear search
                    </a>
                </div>
                {% endif %}
            </div>

            <!-- Comments List -->
            <div class="card p-6">
                <h2 class="text-lg font-heading font-semibold text-gray-900 mb-6">Comments</h2>
                
                {% if comments %}
                <div class="space-y-4">
                    {% for comment in comments %}
                    <div class="border border-gray-200 rounded-lg p-4 {% if not comment.is_approved %}bg-yellow-50{% else %}bg-white{% endif %} hover:shadow-md transition-shadow">
                        <div class="flex items-start justify-between mb-3">
                            <div class="flex items-center space-x-3">
                                <div class="w-10 h-10 bg-purple-100 rounded-full flex items-center justify-center flex-shrink-0">
                                    <span class="text-sm font-bold text-purple-600">{{ comment.user_name|slice:":1"|upper }}</span>
                                </div>
                                <div>
                                    <p class="font-medium text-gray-900">{{ comment.user_name }}</p>
                                    <p class="text-sm text-gray-500">{{ comment.user_email }}</p>
                                </div>
                            </div>
                            <div class="flex items-center space-x-2">
                                {% if comment.is_approved %}
                                <span class="badge badge-success">
                                    <i class="fas fa-check mr-1"></i>
                                    Approved
                                </span>
                                {% else %}
                                <span class="badge badge-warning">
                                    <i class="fas fa-clock mr-1"></i>
                                    Pending
                                </span>
                                {% endif %}
                            </div>
                        </div>

                        <div class="mb-3">
                            <p class="text-gray-700">{{ comment.content }}</p>
                        </div>

                        <div class="flex items-center justify-between text-sm">
                            <div class="flex items-center space-x-4 text-gray-500">
                                <span>
                                    <i class="fas fa-newspaper mr-1"></i>
                                    <a href="{% url 'blog:view_article' comment.article.id %}" class="link">
                                        {{ comment.article.title|truncatechars:40 }}
                                    </a>
                                </span>
                                <span>
                                    <i class="fas fa-clock mr-1"></i>
                                    {{ comment.created_at|date:"M d, Y H:i" }}
                                </span>
                            </div>

                            <div class="flex items-center space-x-2">
                                {% if not comment.is_approved %}
                                <form method="post" action="{% url 'blog:approve_comment' comment.id %}" class="inline">
                                    {% csrf_token %}
                                    <button type="submit" class="text-green-600 hover:text-green-800 font-medium">
                                        <i class="fas fa-check mr-1"></i>
                                        Approve
                                    </button>
                                </form>
                                {% else %}
                                <form method="post" action="{% url 'blog:reject_comment' comment.id %}" class="inline">
                                    {% csrf_token %}
                                    <button type="submit" class="text-orange-600 hover:text-orange-800 font-medium">
                                        <i class="fas fa-ban mr-1"></i>
                                        Unapprove
                                    </button>
                                </form>
                                {% endif %}
                                
                                <form method="post" action="{% url 'blog:delete_comment' comment.id %}" 
                                      onsubmit="return confirm('Are you sure you want to delete this comment? This action cannot be undone.');"
                                      class="inline">
                                    {% csrf_token %}
                                    <button type="submit" class="text-red-600 hover:text-red-800 font-medium">
                                        <i class="fas fa-trash mr-1"></i>
                                        Delete
                                    </button>
                                </form>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>

                <!-- Pagination -->
                {% if comments.has_other_pages %}
                <div class="mt-6 flex items-center justify-center">
                    <nav class="flex items-center space-x-2">
                        {% if comments.has_previous %}
                        <a href="?page={{ comments.previous_page_number }}&status={{ status_filter }}{% if search_query %}&search={{ search_query }}{% endif %}" 
                           class="btn btn-outline">
                            <i class="fas fa-chevron-left"></i>
                        </a>
                        {% endif %}

                        <span class="px-4 py-2 text-sm text-gray-700">
                            Page {{ comments.number }} of {{ comments.paginator.num_pages }}
                        </span>

                        {% if comments.has_next %}
                        <a href="?page={{ comments.next_page_number }}&status={{ status_filter }}{% if search_query %}&search={{ search_query }}{% endif %}" 
                           class="btn btn-outline">
                            <i class="fas fa-chevron-right"></i>
                        </a>
                        {% endif %}
                    </nav>
                </div>
                {% endif %}

                {% else %}
                <div class="text-center py-12">
                    <svg class="w-16 h-16 mx-auto text-gray-400 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"/>
                    </svg>
                    <h3 class="text-lg font-medium text-gray-900 mb-2">No comments found</h3>
                    <p class="text-gray-600">
                        {% if status_filter == 'pending' %}
                        There are no pending comments at the moment.
                        {% elif status_filter == 'approved' %}
                        There are no approved comments yet.
                        {% elif search_query %}
                        No comments match your search criteria. Try different keywords.
                        {% else %}
                        No comments have been submitted yet.
                        {% endif %}
                    </p>
                </div>
                {% endif %}
            </div>
        </main>
    </div>
</div>
{% endblock %}
